pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
#include animation.lua
#include combatant.lua

function array_find(arr, f)
  for a in all(arr) do
    if f(a) then
      return a
    end
  end
end

local function draw_players(players, x, y)
  local w, h = 32, 80
  rectfill(x, y, x + w - 1, y + h - 1, 0)
  rect(x, y, x + w - 1, y + h - 1, 7)

  for i = #players, 1, -1 do
    local player = players[i]
    local x = x + w - 20
    local y = y + i * (h / #players) - (h / #players - 16) / 2 - 16
    combatant_draw(player, x, y)
  end
end

local function draw_player_stat_block(player, x, y)
  local w, h = 32, 20
  rectfill(x, y, x + w - 1, y + h - 1, 0)
  rect(x, y, x + w - 1, y + h - 1, 7)
  print(player.name, x + 4, y + 4, 7)
  print("hp " .. player.hp.current, x + 4, y + 12, 7)
end

local function draw_player_stat_blocks(players, x, y)
  local w = 126
  for i = 1, #players, 1 do
    local player = players[i]
    local px = x + (i - 1) * (w / #players)
    draw_player_stat_block(player, px, y)
  end
end

local function draw_enemies(enemies, x, y)
  local w, h = 80, 80
  rectfill(x, y, x + w - 1, y + h - 1, 0)
  rect(x, y, x + w - 1, y + h - 1, 7)

  for i = 9, 1, -1 do
    local enemy = array_find(enemies, function(e) return e.position == i end)
    if enemy then
      local i = 9 - i + 1
      local ey = y + (i - 1) % 3 * (w / 3) + (w / 3 - 16) / 2
      local ex = x + flr((i - 1) / 3) * (h / 3) + (h / 3 - 16) / 2
      combatant_draw(enemy, ex, ey)
    end
  end
end

local function draw_message(message, x, y)
  local w, h = 116, 14
  rectfill(x, y, x + w - 1, y + h - 1, 0)
  rect(x, y, x + w - 1, y + h - 1, 7)
  print(message, x + 4, y + 4, 7)
end

function _init()
  warrior = warrior_new("vlad")
  wizard = wizard_new("merl")
  players = { warrior, wizard, warrior }

  enemies = {}
  for i = 1, 9, 1 do
    add(enemies, goblin_new(i))
  end
end

function _update()
  if btnp(5) then
    warrior.animation.animation = ANIMATION_WARRIOR_ATTACK
    warrior.animation.t0 = time()
  end
end

function _draw()
  cls(2)
  draw_message("an enemy appears!", 6, 4)
  draw_enemies(enemies, 6, 21)
  draw_players(players, 90, 21)
  draw_player_stat_blocks(players, 6, 104)
end

__gfx__
000000000706600000000000020ccc000000000000055000700b0000000046000000000000000000000000000000000000222000000000000000000000000000
00000000070f600000880000020fc000000077000004550070bbf00000006400000000000000440000000000008800070200220000000000000000400000cc00
007007000708880000088000020ccc00000076007000450070f90000005500f000440000000f444000000600000880020002260900000007f00004440004cc00
0007700000f850f0004bb40702fcc0c000075566070695000f88800004ff480070f44bf000ffff0000000566004cc40200262090000000ffff00024400c44050
00077000000660f00b444407002440f00005770000947500008bf800f04480007004b0000404f060060066600c44440200260590000004f5f540024200c40000
0070070000044000b02200b000ccc000000600000000770000440f80f04450000fb044000404400200666600c02200c002206000000004444440044400044000
00000000006006000b00b00000cccc00007060000004770000b0b00000200800000b00b000404000006056000c00c02020000000000fb347e740042400500c00
00000000004000400400400000400040070060000040999000f00f0000400400000400040040020006050660040040200000000000feb344443b042401500c00
0060000000008000000000000000000000000000007e000000e0000000077770009000000090000009000000000000000000000000ee3b34433bf44000000000
07777700000800000000000000000000007e000000000000000000000000070009a9000000000000000090000000000000000000fef03334330effef00800880
7777000000880000000080000000000007eee00070000e000e007e00000070009a7a9000900090900009a9000000000000000000ffe008822800eee008288280
777600000089800000008800000000000eee2000e0000e200007eee00007777009a900a0000009a9909a7a900000000000000000fe00feb3bef0004082282808
0000000000898800000888000000080000e200000000222e000eee207770000000900a7a00909a7a0009a90000000000000000000000febbbeff004082087800
00000000089798800088980000088000000007e000ee222e0000e20007000000000000a0000a09a900a090000000000000000000000f4e0b0fef000000002700
000000000897798000897900008998000e000e200e0002e00000000077700000000a000000a7a0900a7a00000000000000000000000444004f20400000080070
00000000009779000087798000879800000000000000000000000e000000000000000000000a000000a000000000000000000000002442002444400000080000
000000000b0000300000070000000060000000000000000700000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000eb003200000007708806600000000020000000700000000000000000000000000000000000000000000000000000000000000000000000000000000
00b000000eebbb30000000078878800000000025500000d700000000000000000000000000000000000000000000000000000000000000000000000000000000
000b0000bbeb8b80000000008727000000000025d00000d700000000000000000000000000000000000000000000000000000000000000000000000000000000
000b00003ebbbbbb0000000082820000000002055000007000000000000000000000000000000000000000000000000000000000000000000000000000000000
003b000bb333b7e7000000f00288000000000ddd12200d7000000000000000000000000000000000000000000000000000000000000000000000000000000000
03b0000b3ee00bb000000fff002800000000d222d550522000000000000000000000000000000000000000000000000000000000000000000000000000000000
0bb000bbef0000000000ffeff000ff000000d121ddd5522000000000000000000000000000000000000000000000000000000000000000000000000000000000
0bb000bbfef300000000ff0effffef000000d212d0000d0000000000000000000000000000000000000000000000000000000000000000000000000000000000
0bbbb00bbfe30000000ff00ffff00ef00000d111d0000d0000000000000000000000000000000000000000000000000000000000000000000000000000000000
00bbbbbbbef3000000ffe00eee000ef000000d1d2200000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0bb33bbb3feb000000eee05ee5000eee000021d11200000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bb00bbb3eebb00000f0f0f555000f0ff000055000520000000000000000000000000000000000000000000000000000000000000000000000000000000000000
b00bb003303bb0000f0f00000000f0ef000250000220000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bb0bb00000033b000f0000000000000f0002d0002d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0b707b70000007b70000000000000000002d00002220000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000077777777700000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000770000000000000777777700000000000000000000000000000000000000000000000000000000000fff0000000000000000000000
0000000000000000000007600000000000077777000000000000000000000000000000000000000000000000000000000000000f0f0000000000000000000000
0000000000000000080076000000000000777770000000000000000000000000000000000000000000000000000000000000006fff0000000000000000000000
77000008888000000087688880000000077777000088880000000000000000000088880000000000008800000000000000000ff5ff0006600000000000000000
76000008688800000888086888000000777770000086888000000000000000000086888000000000008808888000000000000f5f666660000000000000000000
07600000f6680000088580f66800000077777080000f66800000000000000080000f6680000000000066086888000000000005fff00000000000000000000000
00760808ff880880405668ff8808800000000080008ff8288800000000000080008ff82888000000006600f66800000000000f500fff00000000000000000000
00078088228284480005882282844800777777886882228444800000777777886882228444800000000588ff8808000000000000000000000000000000000000
00088468888284480000088882844800066666886688828444800000066666886688828444800000000058228228800000000ff0000000000000000000000000
00802850882584480000008825844800000000800008828444800000000000800008828444800000000008888258800000000ff0000000000000000000000000
0000884088508448000000885084480000000080000885844480000000000080000885844480000000000088250880000000f006000000000000000000000000
0000000666650880000006666508800000000000006606688800000000000000006606688800000000006666650880000000f000600000000000000000000000
0000004560664000000045606640000000000000045600664000000000000000045600664000000000004560664800000000f000060000000000000000000000
000000440004400000004400044000000000000004400000440000000000000004400000440000000000440004400000000ff000660000000000000000000000
000006440006600000064400066000000000000064400006440000000000000064400006440000000006440006600000000ffff0666600000000000000000000
67700000888800000000088880000067030000000000000000300000000000000000077770000000000000000000000000700000000000000000000000000000
666700088820000000008882000006670300000000cc0000003000000cc00000000777700000cc00000000000000cc00707000000cc000000666000000000000
666700b888880000000c888880000470030000000cc0000000300000cc00000000777700000cc00000000000000cc00000707000cc0000006dd0600000000000
446000bb87370000000cc8757000440003000000ccc000000030000ccc0000000077700000ccc0000000000000ccc0000070000ccc0000006000000000000000
004bb00333bb0330cc00555cc0cc40000030000444cc0000000300444cc00000077770000444cc00000000000444cc00000700444cc000006660660000000000
0003bb42b3bb03305cc42c5cc0cc000000300ccccc4400000003ccccc44000000777700ccccc44000000000ccccc44007007ccccc44000000ddd666566005000
00034b442222400005c442222400000000300000eecccc000003000eecccc0000000000000eecccc0000000000eecccc0007000eecccc00000d6665655555000
000004244444b300000244444c500000003000076770000000030076770000000333300007677000033330000767700000070076770000000d66d65d65665000
00000002222bbb0000002222ccc00000000fc0c777cc00000000f55777c0000000000f333377cc0000000f333377cc000000f55777c000000d6d6656d6666500
00000044422bb30000044422cc500000000fccc777ccc0000000f5fcccc0000000000fccc7333cc000000fccc7333cc00000f5fcccc000000d6d665666d6d600
000003444043300000c44404550000000003ccc7775ccf00000035fcccc00000000000ccc777533f000000ccc777533f000075fcccc00000d6000655667d7000
000003330000000000ccc000000000000003c0007c44cf00000035007c400000000000c0007c44cf000000c0007c44cf000075007c400000d6006d655666dd00
0000000000000000000000000000000000003004ccc5c00000000304cc5000000000000004ccc5c00000000004ccc5c000000704cc500000d006dd0065566600
00000055555500000005555550000000000030c45ccc5000000003c4ccc500000000000c45ccccc50000000c45ccccc5000007c4ccc50000d606d000000550d0
00000555555550000055555555000000000030c555ccc000000003c55ccc00000000000c5cc05ccc0000000c5cc05ccc000007c55ccc00000006660000000dd0
000000555555000000055555500000000000344400444000000004440444000000000044400004440000004440000444000004440444000000006660000000dd
