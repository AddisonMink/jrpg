pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
#include util.lua
#include load.lua
#include animation.lua
#include spell.lua
#include combatant.lua
#include battle.lua

ANIMATION_ATTACK_OFFSETS = { 0, 2, 5 }
ANIMATION_ATTACK_X_OFFSETS = { -4, -12, -12 }

animation_sleep_id = 104
animation_fire_id = 128

function id_to_sxsy(id)
  local sx = (id % 16) * 8
  local sy = flr(id / 16) * 8
  return sx, sy
end

function load_battle(players, enemies)
  local player_sprite_ids = { 0, 32, 64 }
  local player_sprite_index = 1

  local enemy_sprite_ids = { 96, 98, 100, 102 }
  local enemy_sprite_index = 1

  -- get set of player types
  local player_types = {}
  for p in all(players) do
    player_types[p.type] = true
  end

  -- cache player sprites
  for pt, _ in pairs(player_types) do
    local sprite_id = player_sprite_ids[player_sprite_index]
    cache_player_sprite_data(pt, sprite_id)
    player_types[pt] = sprite_id
    player_sprite_index += 1
  end

  -- get set of enemy types
  local enemy_types = {}
  for e in all(enemies) do
    enemy_types[e.type] = true
  end

  -- cache enemy sprites
  for et, _ in pairs(enemy_types) do
    local sprite_id = enemy_sprite_ids[enemy_sprite_index]
    cache_enemy_sprite_data(et, sprite_id)
    enemy_types[et] = sprite_id
    enemy_sprite_index += 1
  end

  -- initialize players
  for p in all(players) do
    p.side = "player"
    p.sprite_id = player_types[p.type]
    p.state = "idle"
    p.state_started_at = time()
  end

  -- initialize enemies
  local position = 1
  for e in all(enemies) do
    e.side = "enemy"
    e.sprite_id = enemy_types[e.type]
    e.position = position
    position += 1
  end

  return {
    players = players,
    enemies = enemies
  }
end

function draw_battle(battle)
  draw_players(battle.players)
  draw_enemies(battle.enemies)
end

function draw_players(players)
  local x, y = 64, 8

  for p in all(players) do
    draw_player(p, x, y)
    y += 20
  end
end

function draw_enemies(enemies)
  local x, y = 32, 48

  for e in all(enemies) do
    local grid_x = flr((e.position - 1) / 3)
    local grid_y = (e.position - 1) % 3
    local x = x - grid_x * 20
    local y = y - grid_y * 20
    draw_enemy(e, x, y)
  end
end

function draw_player(player, x, y)
  if player.state == "idle" then
    local sx, sy = id_to_sxsy(player.sprite_id)
    sspr(sx, sy, 16, 16, x, y)
  elseif player.state == "attack" then
    local t = time() - player.state_started_at
    local start_id = player.sprite_id + 2
    local frame = min(flr(t * 8), 2) + 1
    local offset = ANIMATION_ATTACK_OFFSETS[frame]
    local id = start_id + offset
    local sx, sy = id_to_sxsy(id)
    local w = frame == 1 and 16 or 20
    local dx = ANIMATION_ATTACK_X_OFFSETS[frame]
    sspr(sx, sy, w, 16, x + dx, y)
  elseif player.state == "special" then
    local start_id = player.sprite_id + 10
    local frame = flr(time() * 8) % 2
    local id = start_id + frame
    local sx, sy = id_to_sxsy(id)
    sspr(sx, sy, 16, 16, x, y)
  end
end

function draw_enemy(enemy, x, y)
  local sx, sy = id_to_sxsy(enemy.sprite_id)
  sspr(sx, sy, 16, 16, x, y)
end

function draw_animation(id, x, y, t0)
  local t = time() - (t0 or 0)
  local frame = flr(t * 8)
  local id = id + frame * 2
  local sx, sy = id_to_sxsy(id)
  if frame < 3 then
    sspr(sx, sy, 16, 16, x, y)
  end
end

function _init()
  reload(0x8000, 0, 0x2000, "data1.p8")

  local players = {
    {
      type = "warrior"
    },
    {
      type = "elf"
    },
    {
      type = "wizard"
    }
  }

  local enemies = {
    {
      type = "goblin"
    },
    {
      type = "goblin"
    },
    {
      type = "goblin"
    },
    {
      type = "goblin"
    }
  }

  battle = load_battle(players, enemies)
end

function _update()
end

function _draw()
  cls()
  draw_battle(battle)
end

__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777000600000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000dd00000000000000070007777700
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ddd00000000deed000000dd00000700077770000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000ddddeeed0000000deed00000deed0007777077760000
00000000000000000000000000000000000000000000000000000000000000000000000ddd000000000deedee7eed0000000dd000000deed7770000000000000
0000000000000000000000000000000000000000000000000000000000000000000000deeed0000000deeedeee7ed000000000ddd0000dd00700000000000000
0000000000000000000000000000000000000000000000000000000000000000000000deeed0000000de7eedeeeed00000000de7ed0000007770000000000000
0000000000000000000000000000000000000000000000000000000000000000000000ee7eed000000de7eeeeded00000000deeeeed000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000edee7edd00000deeeedeeddd0000000deededed00000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000de7deeded0000dedeede7edeed000000de7edeed00000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000deeee7eed0000deeddeeede7ed0000000deede7d00000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000dddeeeed0000de7eedede7eed0000dd00dd0dd000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000dddd000000deeededeeed0000deed000000dd0000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000dddd00ddd00000deed00000deed000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000dd000000deed000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000dd0000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000677000008888000000000000000000000000000000000000
08888800000000000000000000000000000000000000000000000000000000000000000000000000666700088820000000000000000000000000000000000000
00088888000000000000000000000000000000000000000000000000000000000000000000000000666700b88888000000000007000000000000000000000007
00008988800000000000000888888000000000000000000000000000000000000000000000000000446000bb87370000000000ff0000000000000000000000ff
00000899888000000000088888880000000000000000000000000000000000000000000000000000004bb00333bb0330000004f50000000000000000000004f5
000008999888000000008888988000000000000000000000000000000000000000000000000000000003bb42b3bb033000000444000000000000000000000444
0000899999888000000888899800000000000000000000000000000000000000000000000000000000034b4422224000000fb3470000000000000000000fb347
00008997999880000088889998000000000888800000000000000000000000000000000000000000000004244444b30000feb344000000000000000000feb344
0008899779998800008889979980000000000888880000000000000000000000000000000000000000000002222bbb0000ee3b34000000000000000000ee3b34
0088997779999800088889779988800000000089888800000000000000000000000000000000000000000044422bb300fef033340000000000000000fef03334
088997777799980008889977999888000000088999888000000000000000000000000000000000000000034440433000ffe008820000000000000000ffe00882
089977777779980008899777799988000008889979988800000000000000000000000000000000000000033300000000fe00feb30000000000000000fe00feb3
0099777777799800089977777999880000888997779988000000000000000000000000000000000000000000000000000000febb00000000000000000000febb
008997777779900008997777799888000088997777998800000000000000000000000000000000000000005555550000000f4e0b0000000000000000000f4e0b
00099777779900000089977799980000008899777799880000000000000000000000000000000000000005555555500000044400000000000000000000044400
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000555555000000244200000000000000000000244200
00000000000000000000000000000000000000000000000000000000000000000000000000000000000008888000006700000000000000000000070000000060
00000000000000000000000000000000000000000000000000000000000000000000000000000000000088820000066706660000000000000000007708806600
00000000000000000000000000000000000000000000000000000000000000000000000000000000000c8888800004706dd06000000000000000000788788000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000cc8757000440060000000000000000000000087270000
00000000000000000000000000000000000000000000000000000000000000000000000000000000cc00555cc0cc400066606600000000000000000082820000
000000000000000000000000000000000000000000000000000000000000000000000000000000005cc42c5cc0cc00000ddd666566005000000000f002880000
0000000000000000000000000000000000000000000000000000000000000000000000000000000005c442222400000000d666565555500000000fff00280000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000244444c5000000d66d65d656650000000ffeff000ff00
0000000000000000000000000000000000000000000000000000000000000000000000000000000000002222ccc000000d6d6656d66665000000ff0effffef00
0000000000000000000000000000000000000000000000000000000000000000000000000000000000044422cc5000000d6d665666d6d600000ff00ffff00ef0
0000000000000000000000000000000000000000000000000000000000000000000000000000000000c4440455000000d6000655667d700000ffe00eee000ef0
0000000000000000000000000000000000000000000000000000000000000000000000000000000000ccc00000000000d6006d655666dd0000eee05ee5000eee
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d006dd00655666000f0f0f555000f0ff
000000000000000000000000000000000000000000000000000000000000000000000000000000000005555550000000d606d000000550d00f0f00000000f0ef
0000000000000000000000000000000000000000000000000000000000000000000000000000000000555555550000000006660000000dd00f0000000000000f
00000000000000000000000000000000000000000000000000000000000000000000000000000000000555555000000000006660000000dd0000000000000000
