pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
#include spell.lua
#include battle.lua

function combatant_new(type, name, sprite, position, hp, strength)
  return {
    type = type,
    name = name,
    sprite = sprite,
    position = position,
    hp_max = hp,
    hp = hp,
    strength = strength
  }
end

function warrior_new(name, position)
  local sprite = 1
  local hp = 10
  local strength = 1

  local command = {
    name = "guard",
    type = "command"
  }

  local me = combatant_new("player", name, sprite, position, hp, strength)
  me.command = command
  return me
end

function wizard_new(name, position)
  local sprite = 3
  local hp = 6
  local strength = -1
  local spell_uses = { 2 }

  local command = {
    name = "spell",
    type = "spell",
    spells = {
      SPELL_FIRE,
      SPELL_SLEEP
    }
  }

  local me = combatant_new("player", name, sprite, position, hp, strength)
  me.command = command
  me.spell_uses = spell_uses
  return me
end

function cleric_new(name, position)
  local sprite = 5
  local hp = 8
  local strength = 0
  local spell_uses = { 2 }

  local command = {
    name = "pray",
    type = "spell",
    spells = {
      SPELL_HEAL,
      SPELL_BANISH
    }
  }

  local me = combatant_new("player", name, sprite, position, hp, strength)
  me.command = command
  me.spell_uses = spell_uses
  return me
end

function elf_new(name, position)
  local sprite = 6
  local hp = 7
  local strength = 0
  local spell_uses = { 1 }

  local command = {
    name = "sprite",
    type = "spell",
    spells = {
      SPELL_SLEEP,
      SPELL_HEAL
    }
  }

  local me = combatant_new("player", name, sprite, position, hp, strength)
  me.command = command
  me.spell_uses = spell_uses
  return me
end

function goblin_new(position)
  local sprite = 2
  local hp = 3
  local strength = -1
  return combatant_new("enemy", "goblin", sprite, position, hp, strength)
end

function skeleton_new(position)
  local sprite = 4
  local hp = 2
  local strength = 0
  local me = combatant_new("enemy", "skeleton", sprite, position, hp, strength)
  me.undead = true
  return me
end

player1 = cleric_new("ana", 1)
player2 = wizard_new("vlad", 2)
enemy1 = goblin_new(1)
enemy2 = goblin_new(2)
enemy3 = skeleton_new(3)

players = {
  player1,
  player2
}

enemies = {
  enemy1,
  enemy2,
  enemy3
}

combatants = {}

state = "start"
t0 = 0

function _init()
  battle = battle_new(players, enemies)
end

function _update()
  battle:update()
end

function _draw()
  cls(2)
  battle:draw()
end

__gfx__
000000000706600000000000020ccc000000000000055000700b0000000046000000000000000000000000000000000000222000000000000000000000000000
00000000070f600000880000020fc000000077000004550070bbf00000006400000000000000440000000000008800070200220000000000000000400000cc00
007007000708880000088000020ccc00000076007000450070f90000005500f000440000000f444000000600000880020002260900000007f00004440004cc00
0007700000f850f0004bb40702fcc0c000075566070695000f88800004ff480070f44bf000ffff0000000566004cc40200262090000000ffff00024400c44050
00077000000660f00b444407002440f00005770000947500008bf800f04480007004b0000404f060060066600c44440200260590000004f5f540024200c40000
0070070000044000b02200b000ccc000000600000000770000440f80f04450000fb044000404400200666600c02200c002206000000004444440044400044000
00000000006006000b00b00000cccc00007060000004770000b0b00000200800000b00b000404000006056000c00c02020000000000fb347e740042400500c00
00000000004000400400400000400040070060000040999000f00f0000400400000400040040020006050660040040200000000000feb344443b042401500c00
0060000000008000000000000000000000000000007e000000e0000000077770009000000090000009000000000000000000000000ee3b34433bf44000000000
07777700000800000000000000000000007e000000000000000000000000070009a9000000000000000090000000000000000000fef03334330effef00800880
7777000000880000000080000000000007eee00070000e000e007e00000070009a7a9000900090900009a9000000000000000000ffe008822800eee008288280
777600000089800000008800000000000eee2000e0000e200007eee00007777009a900a0000009a9909a7a900000000000000000fe00feb3bef0004082282808
0000000000898800000888000000080000e200000000222e000eee207770000000900a7a00909a7a0009a90000000000000000000000febbbeff004082087800
00000000089798800088980000088000000007e000ee222e0000e20007000000000000a0000a09a900a090000000000000000000000f4e0b0fef000000002700
000000000897798000897900008998000e000e200e0002e00000000077700000000a000000a7a0900a7a00000000000000000000000444004f20400000080070
00000000009779000087798000879800000000000000000000000e000000000000000000000a000000a000000000000000000000002442002444400000080000
000000000b0000300000070000000060000000000000000700000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000eb003200000007708806600000000020000000700000000000000000000000000000000000000000000000000000000000000000000000000000000
00b000000eebbb30000000078878800000000025500000d700000000000000000000000000000000000000000000000000000000000000000000000000000000
000b0000bbeb8b80000000008727000000000025d00000d700000000000000000000000000000000000000000000000000000000000000000000000000000000
000b00003ebbbbbb0000000082820000000002055000007000000000000000000000000000000000000000000000000000000000000000000000000000000000
003b000bb333b7e7000000f00288000000000ddd12200d7000000000000000000000000000000000000000000000000000000000000000000000000000000000
03b0000b3ee00bb000000fff002800000000d222d550522000000000000000000000000000000000000000000000000000000000000000000000000000000000
0bb000bbef0000000000ffeff000ff000000d121ddd5522000000000000000000000000000000000000000000000000000000000000000000000000000000000
0bb000bbfef300000000ff0effffef000000d212d0000d0000000000000000000000000000000000000000000000000000000000000000000000000000000000
0bbbb00bbfe30000000ff00ffff00ef00000d111d0000d0000000000000000000000000000000000000000000000000000000000000000000000000000000000
00bbbbbbbef3000000ffe00eee000ef000000d1d2200000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0bb33bbb3feb000000eee05ee5000eee000021d11200000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bb00bbb3eebb00000f0f0f555000f0ff000055000520000000000000000000000000000000000000000000000000000000000000000000000000000000000000
b00bb003303bb0000f0f00000000f0ef000250000220000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bb0bb00000033b000f0000000000000f0002d0002d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0b707b70000007b70000000000000000002d00002220000000000000000000000000000000000000000000000000000000000000000000000000000000000000
